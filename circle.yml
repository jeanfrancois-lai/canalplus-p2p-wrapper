machine:
    node:
        version: 7
    ruby:
        version: 2.2.0

dependencies:
    pre:
        - gem install aws-sdk
        - 'echo //registry.npmjs.org/:_authToken=${NPM_TOKEN} > ~/.npmrc'

        # Clone tool
        - git config --global user.email $STREAMROOT_EMAIL
        - git config --global user.name $STREAMROOT_USERNAME
        - git clone git@github.com:streamroot/toolkit.git

        # Set peer-agent version
        - toolkit/set_dependency_version.rb --exclude_branches master
                                            --dependency_path dependencies.streamroot-p2p
                                            --version beta
        - npm prune

    override:
        - npm update
    post:
        - npm ls > $CIRCLE_ARTIFACTS/package.lock

test:
    override:
        - npm run prebuild

deployment:
    features:
        branch: /^(?!(?:dev|master)$).+$/
        commands:
            # Generate dist
            - npm run build

            # Add banner to build
            - toolkit/add_banner.rb --file dist/$WRAPPER_NAME.js
                                    --deploy_env $CIRCLE_BRANCH
                                    --dependencies streamroot-p2p

            # Copy build to Circle CI artifacts folder
            - cp dist/$WRAPPER_NAME.js $CIRCLE_ARTIFACTS/$WRAPPER_NAME.js

            # Upload build from artifacts folder to S3
            - toolkit/upload_to_s3.rb --bucket $S3_FEATURES_BUCKET
                                      --region eu-west-1
                                      --file $CIRCLE_ARTIFACTS/$WRAPPER_NAME.js
                                      --destinations $CIRCLE_PROJECT_REPONAME/$CIRCLE_BRANCH/$WRAPPER_NAME.js
                                      --key $S3_KEY
                                      --secret $S3_SECRET

    staging:
        branch: dev
        commands:
            # Generate dist
            - npm run build

    preprod:
        branch: master
        commands:
            # Generate dist
            - npm run build
